---
title: "NOAA Storm Database Analisys - Reproducible Research Peer Assessment 2"
author: "Daniel Resende"
date: "21 de agosto de 2015"
output: html_document
---

## Synopsis

This report explores U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database, which tracks characteristics of major storm and wheather events in the United States, to trace the social and economic impacts of those events.

```{r echo = TRUE, message = FALSE}
if(!("knitr" %in% installed.packages())){
  install.packages("knitr")
}
library(knitr)
if(!("dplyr" %in% installed.packages())){
  install.packages("dplyr")
}
library(dplyr)
if(!("plyr" %in% installed.packages())){
  install.packages("plyr")
}
library(plyr)
if(!("lubridate" %in% installed.packages())){
  install.packages("lubridate")
}
library(lubridate)
if(!("ggplot2" %in% installed.packages())){
  install.packages("ggplot2")
}
library(ggplot2)
```

## Data Processing

The data will be downloaded directly from the source and processed here. No preprocess was done to the data. 

```{r echo = TRUE, cache = TRUE}
if(!file.exists("stormData.bz2")){
  file.url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
  download.file(file.url, "stormData.bz2", method = "curl")
  dateDownloaded <- date()
}
storm.data <- read.csv("stormData.bz2")
colnames(storm.data) <- tolower(colnames(storm.data))
```

### Adjusting the Event Type data.

First the event names were all standardized to upper case, any punctuation was replaced by space, leading and trailing spaces were removed and double spaces were changed to single spaces.

```{r echo = TRUE, cache = TRUE}
levels(storm.data$evtype) <- toupper(levels(storm.data$evtype))
levels(storm.data$evtype) <- gsub("([[:punct:]])|\\s+"," ", levels(storm.data$evtype))
levels(storm.data$evtype) <- gsub("^\\s+|\\s+$", "", levels(storm.data$evtype))
levels(storm.data$evtype) <- gsub("  ", " ", levels(storm.data$evtype))
```

Then the event name were clustered to group toghether diferent classifications of the same event.

```{r echo = TRUE}
types <- levels(storm.data$evtype)
old.types <- types
evclass.clusters <- c("TIDE", "AVALANCHE", "BLIZZARD", "FLOOD", "COLD", "DEBRIS FLOW",
                      "FOG", "SMOKE", "DROUGHT", "DUST", "DUST STORM", "HEAT",
                      "FREEZE", "FUNNEL CLOUD", "HAIL", "RAIN", "SNOW", "HIGH SURF",
                      "WIND", "HURRICANE", "ICE STORM", "LIGHTNING", "HAIL",
                      "RIP CURRENT", "SEICHE", "SLEET", "TORNADO",
                      "TROPICAL DEPRESSION", "TROPICAL STORM", "TSUNAMI",
                      "VOLCANIC ASH", "WATERSPOUT", "WILDFIRE", "WINTER STORM",
                      "WINTER WEATHER")
for(event in evclass.clusters) {
  types[grep(event, types)] <- event
}
storm.data$evtype <- mapvalues(storm.data$evtype, from = old.types, to = types)
```

## Social impact - total harm

As social impact the total harm to society will be analysed. The total harm will be the sum of fatalities and injuries caused by the event type. Thus we'll try to find out which types of events (as indicated in the EVTYPE variable), across all United States, are most harmful with respect to population health.

```{r echo = TRUE}
social <- select(storm.data, evtype, fatalities, injuries) %>%
  mutate(total.harm = fatalities + injuries) %>%
  group_by(evtype) %>%
  summarize(avg.fatalities = mean(fatalities),
            avg.injuries = mean(injuries),
            avg.total.harm = mean(total.harm))
str(social)
```