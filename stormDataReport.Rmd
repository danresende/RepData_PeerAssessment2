---
title: "NOAA Storm Database Analisys - Reproducible Research Peer Assessment 2"
author: "Daniel Resende"
date: "21 de agosto de 2015"
output: html_document
---

## Synopsis

This report explores U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database, which tracks characteristics of major storm and wheather events in the United States, to trace the social and economic impacts of those events.

```{r echo = TRUE, message = FALSE}
if(!("knitr" %in% installed.packages())){
  install.packages("knitr")
}
library(knitr)
if(!("dplyr" %in% installed.packages())){
  install.packages("dplyr")
}
library(dplyr)
if(!("plyr" %in% installed.packages())){
  install.packages("plyr")
}
library(plyr)
if(!("lubridate" %in% installed.packages())){
  install.packages("lubridate")
}
library(lubridate)
if(!("ggplot2" %in% installed.packages())){
  install.packages("ggplot2")
}
library(ggplot2)
```

## Data Processing

The data will be downloaded directly from the source and processed here. No preprocess was done to the data. 

```{r echo = TRUE, cache = TRUE}
if(!file.exists("stormData.bz2")){
  file.url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
  download.file(file.url, "stormData.bz2", method = "curl")
  dateDownloaded <- date()
}
storm.data <- read.csv("stormData.bz2")
colnames(storm.data) <- tolower(colnames(storm.data))
```

### Adjusting the Event Type data.

First the event names were all standardized to upper case, any punctuation was replaced by space, leading and trailing spaces were removed and double spaces were changed to single spaces.

```{r echo = TRUE, cache = TRUE}
levels(storm.data$evtype) <- toupper(levels(storm.data$evtype))
levels(storm.data$evtype) <- gsub("([[:punct:]])|\\s+"," ", levels(storm.data$evtype))
levels(storm.data$evtype) <- gsub("^\\s+|\\s+$", "", levels(storm.data$evtype))
levels(storm.data$evtype) <- gsub("  ", " ", levels(storm.data$evtype))
```

Then the event name were clustered to group toghether diferent classifications of the same event and correct the typos found in the data.

```{r echo = TRUE}
types <- levels(storm.data$evtype)
old.types <- types

#typos
types[grep("AVALANCE", types)] <- "AVALANCHE"
types[grep("BEACH EROSIN", types)] <- "BEACH EROSION"
types[grep("COASTALSTORM", types)] <- "COASTAL STORM"
types[grep("FLASH FLOOODING", types)] <- "FLASH FLOOD"
types[grep("LIGHTING", types)] <- "LIGHTNING"
types[grep("LIGNTNING", types)] <- "LIGHTNING"
types[grep("TORNDAO", types)] <- "TORNADO"
types[grep("BRUSH FIRES", types)] <- "BRUSH FIRE"
types[grep("FLD", types)] <- "FLOOD"

#broad clustering
evclass.clusters <- c("TIDE", "AVALANCHE", "BLIZZARD", "FLOOD", "COLD", "DEBRIS FLOW",
                      "FOG", "SMOKE", "DROUGHT", "DUST", "HEAT", "FREEZ",
                      "FUNNEL CLOUD", "HAIL", "RAIN", "SNOW", "SURF",
                      "WIND", "HURRICANE", "LIGHTNING", "HAIL", "SEICHE",
                      "SLEET", "TORNADO", "TROPICAL DEPRESSION", "STORM",
                      "TSUNAMI", "VOLCANIC", "WATER", "WILDFIRE", "ICE",
                      "EROSION", "COOL", "DRY", "WET", "PRECIP", "FROST", "FUNNEL",
                      "SHOWER", "SWELL", "WAVE", "HYPERTHERMIA", "HYPOTHERMIA", "SLIDE",
                      "WARM", "HIGH TEMP", "SEA", "WINTER", "FIRE", "MARINE", "WINTRY")

for(event in evclass.clusters) {
  types[grep(event, types)] <- event
}

#granular clustering
types[types == "TYPHOON"] <- "HURRICANE"
types[types == "WATER"] <- "FLOOD"
types[types == "SLEET"] <- "SNOW"
types[types == "GLAZE" | types == "ICY ROADS" | types == "FROST"] <- "ICE"
types[types == "SLIDE" | types == "LANDSPOUT"] <- "SLUMP"
types[types == "PRECIP" | types == "SHOWER" | types == "WET"] <- "RAIN"
types[types == "WARM" | types == "HYPERTHERMIA" | types == "HIGH TEMP"] <- "HEAT"
types[types == "FREEZ" | types == "HYPOTHERMIA" | types == "WINTER" |
        types == "WINTRY" | types == "LOW TEMPERATURE" | types == "COOL"] <- "COLD"
types[types == "TSTM" | types == "THUNDERSTORM" | types == "TURBULENCE"] <- "STORM"
types[types == "SURF" | types == "SURGE" | types == "TSUNAMI" | types == "SWELL" |
        types == "SEA" | types =="WAVE" | types == "SEICHE"] <- "WAVES"
types[types == "" | types == "APACHE COUNTY" | types == "DAM BREAK" |
        types =="HEAVY MIX" | types =="RIP CURRENT" | types =="RIP CURRENTS" |
        types =="HIGH" | types == "MARINE" | types == "FUNNEL"] <- "OTHER"

storm.data$evtype <- mapvalues(storm.data$evtype, from = old.types, to = types)
```

## Social impact - total harm

As social impact the total harm to society will be analysed. The total harm will be the sum of fatalities and injuries caused by the event type. Thus we'll try to find out which types of events (as indicated in the EVTYPE variable), across all United States, are most harmful with respect to population health.

```{r echo = TRUE}
social <- dplyr::select(storm.data, evtype, fatalities, injuries) %>%
  dplyr::group_by(evtype) %>%
  dplyr::summarize(fatalities = sum(fatalities),
            injuries = sum(injuries)) %>%
  dplyr::filter(fatalities > 0 | injuries > 0)
kable(social, col.names = c("EVENT TYPE", "FATALITIES", "INJURIES"))
social